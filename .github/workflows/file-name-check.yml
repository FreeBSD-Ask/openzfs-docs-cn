name: ğŸ”— æ£€æŸ¥ SUMMARY.md ç›®å½•

on:
  push:
    paths:
      - '**/*.md'

jobs:
  check-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate SUMMARY.md entries and create issue if mismatch
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const core = require('@actions/core');
            const summaryPath = 'SUMMARY.md';

            if (!fs.existsSync(summaryPath)) {
              core.setFailed("SUMMARY.md not found in the repository.");
            }

            const content = fs.readFileSync(summaryPath, 'utf8');

            // æ­£åˆ™æå–æ‹¬å·é‡Œçš„ .md æ–‡ä»¶è·¯å¾„ï¼Œå…è®¸å‰åç©ºæ ¼
            const regex = /\(\s*([^)]+\.md)\s*\)/g;
            let match;
            const missingEntries = [];

            while ((match = regex.exec(content)) !== null) {
              const filePath = match[1].trim(); // å»æ‰å‰åç©ºæ ¼
              if (!fs.existsSync(filePath)) {
                missingEntries.push(filePath);
              }
            }

            if (missingEntries.length > 0) {
              const body = `ä»¥ä¸‹åœ¨ SUMMARY.md ä¸­çš„æ¡ç›®æ‰¾ä¸åˆ°å¯¹åº”çš„æ–‡ä»¶ï¼š\n\n` +
                           missingEntries.map(e => `- ${e}`).join('\n');
              const issueTitle = 'SUMMARY.md mismatch: Missing files';

              // è·å–å·²æœ‰å¸¦ summary-check æ ‡ç­¾çš„å¼€æ”¾ issue
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'summary-check'
              });

              const exists = issues.some(issue => issue.title === issueTitle);

              if (exists) {
                console.log("å·²å­˜åœ¨å…³äº SUMMARY.md mismatch çš„å¼€æ”¾ issueã€‚");
              } else {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: body,
                  labels: ['summary-check']
                });
                console.log("å·²åˆ›å»ºå…³äº SUMMARY.md mismatch çš„ issueã€‚");
              }

              core.setFailed("SUMMARY.md å­˜åœ¨ç¼ºå¤±æ¡ç›®ï¼Œè¯·æŸ¥çœ‹ issueã€‚");
            } else {
              console.log("æ‰€æœ‰ SUMMARY.md æ¡ç›®å‡æœ‰æ•ˆã€‚");
            }
